# mise.toml - Task runner configuration for aviato-client
# Run tasks with: mise run <task>

# =============================================================================
# Formatting & Linting
# =============================================================================

[tasks.format]
description = "Format code with ruff"
run = "uv run ruff format ."

[tasks."format:check"]
description = "Check formatting without changes"
run = "uv run ruff format --check ."

[tasks.lint]
description = "Lint code with ruff (auto-fix enabled)"
run = "uv run ruff check --fix ."

[tasks."lint:check"]
description = "Lint code without auto-fix"
run = "uv run ruff check ."

# =============================================================================
# Type Checking
# =============================================================================

[tasks.typecheck]
description = "Run mypy type checking"
run = "uv run mypy src/"
alias = "tc"

# =============================================================================
# Testing
# =============================================================================

[tasks.test]
description = "Run unit tests"
run = "uv run pytest"
alias = "t"

[tasks."test:unit"]
description = "Run unit tests (explicit)"
run = "uv run pytest tests/unit/"

[tasks."test:e2e"]
description = "Run integration/e2e tests (requires auth)"
run = "uv run pytest tests/integration/ -v"
alias = "e2e"

[tasks."test:e2e:parallel"]
description = "Run integration tests in parallel"
run = "uv run pytest tests/integration/ -n auto -v"

[tasks."test:all"]
description = "Run all tests (unit + integration)"
run = "uv run pytest tests/unit/ tests/integration/ -v"

[tasks."test:cov"]
description = "Run unit tests with coverage"
run = "uv run pytest --cov=src --cov-report=term-missing"

# =============================================================================
# Combined Quality Checks
# =============================================================================

[tasks.check]
description = "Run all quality checks (runs in parallel)"
depends = ["format:check", "lint:check", "typecheck", "test"]
alias = "c"

# =============================================================================
# Development Helpers
# =============================================================================

[tasks.install]
description = "Install project dependencies"
run = "uv sync --extra dev"

[tasks.clean]
description = "Remove build artifacts and caches"
run = [
    "rm -rf .mypy_cache .pytest_cache .ruff_cache",
    "rm -rf dist build *.egg-info",
    "find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true",
]

[tasks.precommit]
description = "Run pre-commit hooks"
run = "uv run pre-commit run --all-files"
alias = "pc"

# =============================================================================
# Local Backend Development
# =============================================================================

[tasks."dev:local-protos"]
description = "Install locally-generated protos from aviato backend repo"
run = """
#!/bin/bash
set -e

BACKEND_REPO="${AVIATO_BACKEND_PATH:-../aviato}"

if [ ! -d "$BACKEND_REPO" ]; then
    echo "Error: Backend repo not found at $BACKEND_REPO"
    echo "Set AVIATO_BACKEND_PATH or ensure ../aviato exists"
    exit 1
fi

echo "==> Generating Python protos from $BACKEND_REPO..."
(cd "$BACKEND_REPO" && make buf-gen-python)

echo "==> Installing local protos into client venv..."
uv pip install "$BACKEND_REPO/gen/python" --reinstall-package coreweave-aviato-grpc-python --no-deps

echo "==> Verifying installation..."
VERSION=$(uv pip show coreweave-aviato-grpc-python | grep Version | cut -d' ' -f2)
echo "Installed: coreweave-aviato-grpc-python==$VERSION"

echo ""
echo "Done! Local protos installed."
echo ""
echo "Usage with local protos:"
echo "  uv run --no-sync pytest ...    # Run tests without reverting"
echo "  uv run --no-sync python ...    # Run scripts without reverting"
echo "  mise run dev:revert-protos     # Revert to published protos"
"""

[tasks."dev:lint"]
description = "Lint without syncing (preserves local protos)"
run = "uv run --no-sync ruff check ."

[tasks."dev:typecheck"]
description = "Typecheck without syncing (preserves local protos)"
run = "uv run --no-sync mypy src/"

[tasks."dev:test"]
description = "Run unit tests without syncing (preserves local protos)"
run = "uv run --no-sync pytest tests/unit/"

[tasks."dev:test:e2e"]
description = "Run integration tests without syncing (preserves local protos)"
run = "uv run --no-sync pytest tests/integration/ -v"

[tasks."dev:check"]
description = "Run all quality checks without syncing (preserves local protos)"
depends = ["dev:lint", "dev:typecheck", "dev:test"]

[tasks."dev:revert-protos"]
description = "Revert to published protos (runs uv sync)"
run = "uv sync --extra dev"
