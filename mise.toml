# mise.toml - Task runner configuration for aviato-client
# Run tasks with: mise run <task>

# =============================================================================
# Formatting & Linting
# =============================================================================

[tasks.format]
description = "Format code with ruff"
run = "uv run ruff format ."

[tasks."format:check"]
description = "Check formatting without changes"
run = "uv run ruff format --check ."

[tasks.lint]
description = "Lint code with ruff (auto-fix enabled)"
run = "uv run ruff check --fix ."

[tasks."lint:check"]
description = "Lint code without auto-fix"
run = "uv run ruff check ."

# =============================================================================
# Type Checking
# =============================================================================

[tasks.typecheck]
description = "Run mypy type checking"
run = "uv run mypy src/"
alias = "tc"

# =============================================================================
# Testing
# =============================================================================

[tasks.test]
description = "Run unit tests"
run = "uv run pytest"
alias = "t"

[tasks."test:unit"]
description = "Run unit tests (explicit)"
run = "uv run pytest tests/unit/"

[tasks."test:e2e"]
description = "Run integration/e2e tests (requires auth)"
run = "uv run pytest tests/integration/ -v"
alias = "e2e"

[tasks."test:e2e:parallel"]
description = "Run integration tests in parallel"
run = "uv run pytest tests/integration/ -n auto -v"

[tasks."test:all"]
description = "Run all tests (unit + integration)"
run = "uv run pytest tests/unit/ tests/integration/ -v"

[tasks."test:cov"]
description = "Run unit tests with coverage"
run = "uv run pytest --cov=src --cov-report=term-missing"

# =============================================================================
# Combined Quality Checks
# =============================================================================

[tasks.check]
description = "Run all quality checks (runs in parallel)"
depends = ["format:check", "lint:check", "typecheck", "test"]
alias = "c"

# =============================================================================
# Development Helpers
# =============================================================================

[tasks.install]
description = "Install project dependencies"
run = "uv sync --extra dev"

[tasks.clean]
description = "Remove build artifacts and caches"
run = [
    "rm -rf .mypy_cache .pytest_cache .ruff_cache",
    "rm -rf dist build *.egg-info",
    "find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true",
]

[tasks.precommit]
description = "Run pre-commit hooks"
run = "uv run pre-commit run --all-files"
alias = "pc"

# =============================================================================
# Local Development (Backend Integration)
# =============================================================================

[tasks."dev:protos"]
description = "Regenerate Python protos from local backend and install"
run = """
#!/usr/bin/env bash
set -euo pipefail

BACKEND_DIR="${AVIATO_BACKEND_DIR:-../aviato}"

if [[ ! -d "$BACKEND_DIR" ]]; then
    echo "Error: Backend directory not found at $BACKEND_DIR"
    echo "Set AVIATO_BACKEND_DIR to the correct path"
    exit 1
fi

(cd "$BACKEND_DIR" && make buf-gen-python)
uv pip install -e "$BACKEND_DIR/gen/python"

echo "Done!"
"""
