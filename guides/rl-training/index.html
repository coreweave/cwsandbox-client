
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Python client library for Aviato sandboxes">
      
      
      
        <link rel="canonical" href="https://coreweave.github.io/aviato-client/guides/rl-training/">
      
      
        <link rel="prev" href="../swebench/">
      
      
        <link rel="next" href="../../api/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>RL Training - Aviato Client</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#rl-training-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Aviato Client" class="md-header__button md-logo" aria-label="Aviato Client" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Aviato Client
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              RL Training
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/coreweave/aviato-client" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    coreweave/aviato-client
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tutorial/01-first-sandbox/" class="md-tabs__link">
          
  
  
  Tutorial

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../execution/" class="md-tabs__link">
          
  
  
  Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../api/" class="md-tabs__link">
        
  
  
    
  
  API Reference

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Aviato Client" class="md-nav__button md-logo" aria-label="Aviato Client" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Aviato Client
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/coreweave/aviato-client" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    coreweave/aviato-client
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorial
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorial
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/01-first-sandbox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Your First Sandbox
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/02-configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Configuring Sandboxes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/03-running-commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Running Commands
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/04-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Streaming Output
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/05-files/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Reading & Writing Files
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/06-multiple-sandboxes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Managing Multiple Sandboxes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/07-remote-functions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. Remote Function Execution
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/08-cleanup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. Cleanup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../execution/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Command Execution
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../file-operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    File Operations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sessions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sessions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../remote-functions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Remote Functions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sandbox-configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sandbox Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cleanup-patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cleanup Patterns
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sync-vs-async/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sync vs Async
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../swebench/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SWE-bench Evaluation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    RL Training
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    RL Training
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#contents" class="md-nav__link">
    <span class="md-ellipsis">
      
        Contents
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-sandboxes-for-agent-tool-execution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why sandboxes for agent tool execution
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#training-step-with-parallel-episodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Training step with parallel episodes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tagging-for-job-metadata" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tagging for job metadata
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-it-reward_functionpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Try it: reward_function.py
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trl-grpotrainer-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        TRL GRPOTrainer integration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-it-trl_grpo_integrationpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Try it: trl_grpo_integration.py
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling-in-agent-episodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error handling in agent episodes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wb-metrics-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        W&amp;B metrics integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="W&amp;B metrics integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#auto-detection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Auto-detection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        Explicit control
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#per-sandbox-exec-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Per-sandbox exec metrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-and-debugging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitoring and debugging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring and debugging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#counting-active-sandboxes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Counting active sandboxes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging-execution-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logging execution details
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-step-rollouts-with-art" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-step rollouts with ART
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Multi-step rollouts with ART">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#training-approach-grpo-with-distillation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Training approach: GRPO with distillation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prerequisites_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Running the example
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration options
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data flow
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#contents" class="md-nav__link">
    <span class="md-ellipsis">
      
        Contents
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-sandboxes-for-agent-tool-execution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why sandboxes for agent tool execution
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#training-step-with-parallel-episodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Training step with parallel episodes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tagging-for-job-metadata" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tagging for job metadata
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-it-reward_functionpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Try it: reward_function.py
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trl-grpotrainer-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        TRL GRPOTrainer integration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-it-trl_grpo_integrationpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Try it: trl_grpo_integration.py
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling-in-agent-episodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error handling in agent episodes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wb-metrics-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        W&amp;B metrics integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="W&amp;B metrics integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#auto-detection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Auto-detection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        Explicit control
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#per-sandbox-exec-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Per-sandbox exec metrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-and-debugging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitoring and debugging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring and debugging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#counting-active-sandboxes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Counting active sandboxes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging-execution-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logging execution details
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-step-rollouts-with-art" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-step rollouts with ART
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Multi-step rollouts with ART">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#training-approach-grpo-with-distillation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Training approach: GRPO with distillation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prerequisites_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Running the example
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration options
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data flow
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="rl-training-guide">RL training guide<a class="headerlink" href="#rl-training-guide" title="Permanent link">&para;</a></h1>
<p>How to use Aviato sandboxes for RL training workflows where models execute tool calls in isolated environments.</p>
<h2 id="contents">Contents<a class="headerlink" href="#contents" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#why-sandboxes-for-agent-tool-execution">Why sandboxes for agent tool execution</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#core-pattern">Core pattern</a></li>
<li><a href="#tagging-for-job-metadata">Tagging for job metadata</a></li>
<li><a href="#try-it-reward_functionpy">Try it: reward_function.py</a></li>
<li><a href="#trl-grpotrainer-integration">TRL GRPOTrainer integration</a></li>
<li><a href="#try-it-trl_grpo_integrationpy">Try it: trl_grpo_integration.py</a></li>
<li><a href="#error-handling-in-agent-episodes">Error handling in agent episodes</a></li>
<li><a href="#wb-metrics-integration">W&amp;B metrics integration</a></li>
<li><a href="#monitoring-and-debugging">Monitoring and debugging</a></li>
<li><a href="#multi-step-rollouts-with-art">Multi-step rollouts with ART</a></li>
</ul>
<h2 id="why-sandboxes-for-agent-tool-execution">Why sandboxes for agent tool execution<a class="headerlink" href="#why-sandboxes-for-agent-tool-execution" title="Permanent link">&para;</a></h2>
<p>Training code agents with RL requires executing tool calls (bash commands, file operations) in isolated environments. Untrusted model-generated code might modify the host filesystem, hit the network, or produce non-deterministic results. Sandboxes give you isolated, ephemeral environments where tool calls run without affecting the host or other rollouts.</p>
<p>In a training loop, the model generates actions (tool calls), the sandbox executes them, and observations flow back to the model. The sandbox persists across tool calls within an episode, so file changes and installed packages carry over between steps. Reward comes from the final sandbox state (e.g., tests passing) or trajectory quality.</p>
<p>The tagging and listing APIs make it practical to clean up and monitor training runs with thousands of sandboxes.</p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<p>Set your API key:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AVIATO_API_KEY</span><span class="o">=</span><span class="s2">&quot;your-api-key&quot;</span>
</code></pre></div>
<p>Install aviato from source (from repo root):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.
</code></pre></div>
<h2 id="core-pattern">Core pattern<a class="headerlink" href="#core-pattern" title="Permanent link">&para;</a></h2>
<p>The basic setup: an agent loop runs on your training infrastructure, and tool calls execute in a sandbox.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">aviato</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aviato</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sandbox</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_agent_episode</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">sandbox</span><span class="p">:</span> <span class="n">Sandbox</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run one agent episode, returning trajectory and reward.&quot;&quot;&quot;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]}]</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_steps&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>        <span class="c1"># Model generates next action</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">})</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">parse_tool_calls</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_calls</span><span class="p">:</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>            <span class="k">break</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>        <span class="c1"># Execute tool calls in sandbox</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>            <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;bash&quot;</span><span class="p">:</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>                    <span class="p">[</span><span class="s2">&quot;bash&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">tool</span><span class="o">.</span><span class="n">command</span><span class="p">],</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>                    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>                <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>                <span class="n">observation</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;exit=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="si">}{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>            <span class="k">elif</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;read_file&quot;</span><span class="p">:</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>                <span class="n">observation</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>            <span class="k">elif</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;write_file&quot;</span><span class="p">:</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>                <span class="n">sandbox</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">tool</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>                <span class="n">observation</span> <span class="o">=</span> <span class="s2">&quot;File written successfully&quot;</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">observation</span><span class="p">})</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>    <span class="c1"># Compute reward from final sandbox state</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>    <span class="n">test_result</span> <span class="o">=</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;test_command&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>    <span class="n">reward</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">test_result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>    <span class="k">return</span> <span class="n">messages</span><span class="p">,</span> <span class="n">reward</span>
</code></pre></div>
<p>The sandbox persists across tool calls within an episode, so file changes accumulate as the agent works.</p>
<h3 id="training-step-with-parallel-episodes">Training step with parallel episodes<a class="headerlink" href="#training-step-with-parallel-episodes" title="Permanent link">&para;</a></h3>
<p>Process a batch of tasks with one sandbox per episode:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run agent episodes for a batch of tasks.&quot;&quot;&quot;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="c1"># Create and pre-start all sandboxes in parallel</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="n">sandboxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">session</span><span class="o">.</span><span class="n">sandbox</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="n">refs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sb</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">sb</span> <span class="ow">in</span> <span class="n">sandboxes</span><span class="p">]</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">]</span>  <span class="c1"># Wait for all backends to accept</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="n">trajectories</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="k">for</span> <span class="n">task</span><span class="p">,</span> <span class="n">sandbox</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">sandboxes</span><span class="p">):</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>        <span class="n">trajectory</span><span class="p">,</span> <span class="n">reward</span> <span class="o">=</span> <span class="n">run_agent_episode</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">sandbox</span><span class="p">)</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>        <span class="n">trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>        <span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reward</span><span class="p">)</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>        <span class="n">sandbox</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>  <span class="c1"># Non-blocking cleanup</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    <span class="c1"># trajectories and rewards go to policy update</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>    <span class="k">return</span> <span class="n">rewards</span>
</code></pre></div>
<h2 id="tagging-for-job-metadata">Tagging for job metadata<a class="headerlink" href="#tagging-for-job-metadata" title="Permanent link">&para;</a></h2>
<p>Tags let you filter and find sandboxes created by your training jobs. Include metadata that helps identify sandboxes when debugging or cleaning up:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aviato</span><span class="w"> </span><span class="kn">import</span> <span class="n">SandboxDefaults</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_defaults</span><span class="p">(</span><span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SandboxDefaults</span><span class="p">:</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="k">return</span> <span class="n">SandboxDefaults</span><span class="p">(</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>        <span class="n">container_image</span><span class="o">=</span><span class="s2">&quot;python:3.11&quot;</span><span class="p">,</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="n">tags</span><span class="o">=</span><span class="p">(</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>            <span class="sa">f</span><span class="s2">&quot;wandb-run:</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;WANDB_RUN_ID&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>            <span class="sa">f</span><span class="s2">&quot;slurm-job:</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SLURM_JOB_ID&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;interactive&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>            <span class="sa">f</span><span class="s2">&quot;model:</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>            <span class="s2">&quot;rl-training&quot;</span><span class="p">,</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        <span class="p">),</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="p">)</span>
</code></pre></div>
<p>Useful metadata to include in tags:</p>
<table>
<thead>
<tr>
<th>Tag Pattern</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>wandb-run:{id}</code></td>
<td>W&amp;B run ID (from <code>WANDB_RUN_ID</code> env var) for filtering by training run</td>
</tr>
<tr>
<td><code>slurm-job:{id}</code></td>
<td>Slurm job ID (from <code>SLURM_JOB_ID</code> env var) for cluster job tracking</td>
</tr>
<tr>
<td><code>model:{name}</code></td>
<td>Model name or checkpoint for multi-model experiments</td>
</tr>
<tr>
<td><code>env:{name}</code></td>
<td>Environment (dev, staging, prod) for resource management</td>
</tr>
</tbody>
</table>
<p>Sandbox tags become Kubernetes pod labels, which the CoreWeave observability platform uses for filtering and dashboards.</p>
<h2 id="try-it-reward_functionpy">Try it: reward_function.py<a class="headerlink" href="#try-it-reward_functionpy" title="Permanent link">&para;</a></h2>
<p>A minimal integration: compute code execution rewards with parallel sandbox execution.</p>
<p><strong>What it does:</strong>
- Executes a set of toy code completions (arithmetic, string operations, syntax errors, runtime errors)
- Creates one sandbox per completion for isolation
- Computes binary rewards: 1.0 for successful execution, 0.0 for failure
- Shows progress as results arrive (faster executions complete first)</p>
<p><strong>How it uses Aviato:</strong></p>
<p>The example uses <code>aviato.wait()</code> to process results as they complete:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Create sandboxes and execute all completions in parallel</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">processes</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">session</span><span class="o">.</span><span class="n">sandbox</span><span class="p">()</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>        <span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">],</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>        <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">EXECUTION_TIMEOUT_SECONDS</span><span class="p">,</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="p">)</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">completions</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="p">]</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="c1"># Collect results as they complete</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="k">while</span> <span class="n">pending</span><span class="p">:</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    <span class="p">[</span><span class="n">process</span><span class="p">],</span> <span class="n">pending</span> <span class="o">=</span> <span class="n">aviato</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">pending</span><span class="p">,</span> <span class="n">num_returns</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    <span class="n">reward</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</code></pre></div>
<p><strong>Run it:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>uv<span class="w"> </span>run<span class="w"> </span>examples/rl_training/reward_function.py
</code></pre></div>
<p>No additional dependencies required. No GPU needed.</p>
<p><strong>Expected output:</strong></p>
<p>Results arrive as executions complete, so faster problems finish first:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>RL Training Reward Function Example (job: cc92116b)
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>============================================================
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>Evaluating 5 completions...
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>Progress (results arrive as executions complete):
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>------------------------------------------------------------
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>  [1/5] Problem 1 (string-ops): PASS
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>  [2/5] Problem 3 (syntax-error): FAIL
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>  [3/5] Problem 2 (delayed-error): FAIL
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>  [4/5] Problem 0 (slow-sum): PASS
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>  [5/5] Problem 4 (slow-list): PASS
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>------------------------------------------------------------
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>Final summary (original order):
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>------------------------------------------------------------
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>  Problem 0 (slow-sum): reward=1.0 [PASS] OK
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>  Problem 1 (string-ops): reward=1.0 [PASS] OK
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>  Problem 2 (delayed-error): reward=0.0 [FAIL] OK
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>  Problem 3 (syntax-error): reward=0.0 [FAIL] OK
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>  Problem 4 (slow-list): reward=1.0 [PASS] OK
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>------------------------------------------------------------
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>Total reward: 3.0/5
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>Pass rate: 3/5 (60%)
</code></pre></div>
<h2 id="trl-grpotrainer-integration">TRL GRPOTrainer integration<a class="headerlink" href="#trl-grpotrainer-integration" title="Permanent link">&para;</a></h2>
<p>TRL uses a reward function interface where completions map directly to rewards. The agent generates a completion, and the reward function executes it in a sandbox.</p>
<p>The standard pattern uses <code>&lt;answer&gt;</code> XML tags for code extraction (matching the format used in GRPO math examples with <code>\boxed{}</code>):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">aviato</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aviato</span><span class="w"> </span><span class="kn">import</span> <span class="n">SandboxDefaults</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="n">session</span> <span class="o">=</span> <span class="n">aviato</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">defaults</span><span class="o">=</span><span class="n">SandboxDefaults</span><span class="p">(</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="n">container_image</span><span class="o">=</span><span class="s2">&quot;python:3.11&quot;</span><span class="p">,</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="n">tags</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;trl-grpo&quot;</span><span class="p">,),</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="p">))</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">extract_xml_answer</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="k">if</span> <span class="s2">&quot;&lt;answer&gt;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;answer&gt;&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;/answer&gt;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">reward_fn</span><span class="p">(</span><span class="n">completions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    <span class="c1"># Conversational datasets pass message dicts, standard datasets pass strings</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">completions</span><span class="p">]</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>    <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">extract_xml_answer</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>    <span class="n">code_indices</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span> <span class="k">if</span> <span class="n">code</span><span class="p">]</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>    <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>        <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">sandbox</span><span class="p">()</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>            <span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">],</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>            <span class="n">timeout_seconds</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>        <span class="p">))</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">code_indices</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>    <span class="p">]</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>            <span class="n">rewards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>            <span class="k">pass</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>    <span class="k">return</span> <span class="n">rewards</span>
</code></pre></div>
<p>This pattern works for training models to generate correct code in a single turn.</p>
<h2 id="try-it-trl_grpo_integrationpy">Try it: trl_grpo_integration.py<a class="headerlink" href="#try-it-trl_grpo_integrationpy" title="Permanent link">&para;</a></h2>
<p>Uses Aviato sandboxes with TRL's GRPOTrainer for code execution rewards.</p>
<p><strong>What it does:</strong>
- Loads a small model (<code>Qwen/Qwen2.5-0.5B-Instruct</code>)
- Creates a toy dataset of simple coding problems
- Trains the model using GRPO with sandbox-based reward computation
- Runs 10 training steps to demonstrate the integration</p>
<p><strong>How it uses Aviato:</strong></p>
<p>The reward function extracts code from <code>&lt;answer&gt;</code> tags (the standard GRPO pattern), creates sandboxes in parallel through a Session, executes each completion, and returns binary rewards:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">extract_xml_answer</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract answer from XML-style &lt;answer&gt; tags.&quot;&quot;&quot;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="k">if</span> <span class="s2">&quot;&lt;answer&gt;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="n">answer</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;answer&gt;&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">answer</span> <span class="o">=</span> <span class="n">answer</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;/answer&gt;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="k">return</span> <span class="n">answer</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">code_execution_reward</span><span class="p">(</span><span class="n">completions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="c1"># Conversational datasets pass message dicts, standard datasets pass strings</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">completions</span><span class="p">]</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">extract_xml_answer</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="c1"># Create sandboxes and execute non-empty code in parallel</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>    <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>        <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">sandbox</span><span class="p">()</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>            <span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">],</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">EXECUTION_TIMEOUT_SECONDS</span><span class="p">,</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>        <span class="p">))</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span> <span class="k">if</span> <span class="n">code</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>    <span class="p">]</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>    <span class="c1"># Collect rewards, defaulting to 0.0</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>            <span class="n">rewards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>            <span class="n">rewards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>    <span class="k">return</span> <span class="n">rewards</span>
</code></pre></div>
<p>The prompts use a system message instructing the model to format code with <code>&lt;answer&gt;</code> tags:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">SYSTEM_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You solve coding problems by writing Python code.</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="s2">Put your code inside &lt;answer&gt; tags like this: &lt;answer&gt;print(&quot;hello&quot;)&lt;/answer&gt;</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="s2">Only include the code, no explanations.&quot;&quot;&quot;</span>
</code></pre></div>
<p>The Session tracks sandboxes and cleans them up when it closes.</p>
<p><strong>Run it:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span><span class="nv">trl</span><span class="o">==</span><span class="m">0</span>.27.1<span class="w"> </span><span class="nv">transformers</span><span class="o">==</span><span class="m">5</span>.0.0<span class="w"> </span><span class="nv">datasets</span><span class="o">==</span><span class="m">4</span>.5.0<span class="w"> </span><span class="nv">torch</span><span class="o">==</span><span class="m">2</span>.10.0
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>uv<span class="w"> </span>run<span class="w"> </span>examples/rl_training/trl_grpo_integration.py
</code></pre></div>
<p>GPU is recommended for reasonable performance. Without one, training works but is slow.</p>
<p><strong>Expected output:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>TRL GRPO Integration Example (job: def67890)
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>============================================================
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>Loading model: Qwen/Qwen2.5-0.5B-Instruct
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>Creating toy dataset...
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>Dataset size: 5 problems
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>Setting up GRPOTrainer...
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>Starting training (10 steps)...
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>------------------------------------------------------------
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>  [Aviato] Reward call 1: 2 sandboxes, 0/2 passed
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>  [Aviato] Reward call 2: 1 sandboxes, 0/1 passed, 1 skipped (no code)
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>  [Aviato] Reward call 3: 0 sandboxes, 0/0 passed, 2 skipped (no code)
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>  [Aviato] Reward call 4: 2 sandboxes, 0/2 passed
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>  ...
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>  [Aviato] Reward call 8: 2 sandboxes, 1/2 passed
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>  [Aviato] Reward call 9: 2 sandboxes, 1/2 passed
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>  [Aviato] Reward call 10: 1 sandboxes, 0/1 passed, 1 skipped (no code)
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>[training logs]
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>------------------------------------------------------------
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>Training completed successfully!
</code></pre></div>
<p><strong>Understanding the output:</strong></p>
<p>The number of sandboxes varies per step because we only create sandboxes when <code>extract_xml_answer()</code> finds extractable code in the model's completion. When the model generates text without the expected <code>&lt;answer&gt;...&lt;/answer&gt;</code> tags, that completion is skipped and receives a reward of 0.0.</p>
<ul>
<li><code>2 sandboxes, 0/2 passed</code> - Model generated 2 code blocks, both failed execution</li>
<li><code>1 sandboxes, 0/1 passed, 1 skipped (no code)</code> - Model generated 1 code block (failed) and 1 text-only completion</li>
<li><code>0 sandboxes, 0/0 passed, 2 skipped (no code)</code> - Model generated no extractable code in either completion</li>
</ul>
<p>Expected with a small, untrained model. As training progresses, you should see fewer skipped completions and more passes.</p>
<h2 id="error-handling-in-agent-episodes">Error handling in agent episodes<a class="headerlink" href="#error-handling-in-agent-episodes" title="Permanent link">&para;</a></h2>
<p>Sandbox operations can fail (timeouts, missing files, sandbox termination). Return observations that help the agent understand what went wrong:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aviato</span><span class="w"> </span><span class="kn">import</span> <span class="n">SandboxTimeoutError</span><span class="p">,</span> <span class="n">SandboxFileError</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute_tool</span><span class="p">(</span><span class="n">sandbox</span><span class="p">,</span> <span class="n">tool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a tool call, returning an observation string.&quot;&quot;&quot;</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>        <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;bash&quot;</span><span class="p">:</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>                <span class="p">[</span><span class="s2">&quot;bash&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">tool</span><span class="o">.</span><span class="n">command</span><span class="p">],</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>                <span class="n">timeout_seconds</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>            <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;exit=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="si">}{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>        <span class="k">elif</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;read_file&quot;</span><span class="p">:</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>            <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>        <span class="k">elif</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;write_file&quot;</span><span class="p">:</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>            <span class="n">sandbox</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">tool</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>            <span class="k">return</span> <span class="s2">&quot;File written successfully&quot;</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>    <span class="k">except</span> <span class="n">SandboxTimeoutError</span><span class="p">:</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>        <span class="k">return</span> <span class="s2">&quot;Error: command timed out after 30 seconds&quot;</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>    <span class="k">except</span> <span class="n">SandboxFileError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<p>For reward computation, catch exceptions and return a fallback reward instead of propagating to the training loop.</p>
<h2 id="wb-metrics-integration">W&amp;B metrics integration<a class="headerlink" href="#wb-metrics-integration" title="Permanent link">&para;</a></h2>
<p>When using W&amp;B (Weights &amp; Biases) for training, aviato Sessions log sandbox usage metrics to your active wandb run automatically.</p>
<h3 id="auto-detection">Auto-detection<a class="headerlink" href="#auto-detection" title="Permanent link">&para;</a></h3>
<p>If <code>WANDB_API_KEY</code> is set and a wandb run is active (<code>wandb.run</code> exists), metrics logging is enabled automatically:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">wandb</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aviato</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">SandboxDefaults</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s2">&quot;my-rl-training&quot;</span><span class="p">)</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="c1"># Metrics logging enabled automatically</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>        <span class="n">sandbox</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">sandbox</span><span class="p">()</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>        <span class="c1"># Exec results are automatically tracked - no manual calls needed</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">exec</span><span class="p">([</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">])</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>        <span class="c1"># Log metrics at this training step for correlation</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>        <span class="n">session</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="c1"># Final metrics logged on session close</span>
</code></pre></div>
<h3 id="explicit-control">Explicit control<a class="headerlink" href="#explicit-control" title="Permanent link">&para;</a></h3>
<p>Control metrics reporting with the <code>report_to</code> parameter:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># Explicit opt-in (creates reporter; metrics logged when wandb.run exists)</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">report_to</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;wandb&quot;</span><span class="p">])</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="c1"># Disable reporting (even if wandb run exists)</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">report_to</span><span class="o">=</span><span class="p">[])</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="c1"># Auto-detect (default behavior)</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">report_to</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<h3 id="metrics">Metrics<a class="headerlink" href="#metrics" title="Permanent link">&para;</a></h3>
<p>Execution metrics are tracked automatically when <code>exec()</code> completes:</p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>aviato/sandboxes_created</code></td>
<td>Total sandboxes created via session</td>
</tr>
<tr>
<td><code>aviato/executions</code></td>
<td>Total exec() calls</td>
</tr>
<tr>
<td><code>aviato/exec_completed_ok</code></td>
<td>Completed executions (returncode=0)</td>
</tr>
<tr>
<td><code>aviato/exec_completed_nonzero</code></td>
<td>Completed executions (returncode!=0)</td>
</tr>
<tr>
<td><code>aviato/exec_failures</code></td>
<td>Failed executions (timeouts, transport failures)</td>
</tr>
<tr>
<td><code>aviato/exec_completion_rate</code></td>
<td>Fraction of exec() that completed with returncode=0</td>
</tr>
<tr>
<td><code>aviato/exec_failure_rate</code></td>
<td>Fraction of exec() that failed to complete</td>
</tr>
<tr>
<td><code>aviato/startup_count</code></td>
<td>Number of sandbox startup times recorded</td>
</tr>
<tr>
<td><code>aviato/avg_startup_seconds</code></td>
<td>Average sandbox startup time</td>
</tr>
<tr>
<td><code>aviato/min_startup_seconds</code></td>
<td>Minimum sandbox startup time</td>
</tr>
<tr>
<td><code>aviato/max_startup_seconds</code></td>
<td>Maximum sandbox startup time</td>
</tr>
</tbody>
</table>
<p>Tracking is automatic: just call <code>exec()</code> on any sandbox associated with a session. Call <code>session.log_metrics(step=N)</code> to log at specific training steps:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>        <span class="n">sandbox</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">sandbox</span><span class="p">()</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>        <span class="c1"># Metrics tracked automatically on exec() completion</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">exec</span><span class="p">([</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]])</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>        <span class="n">reward</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>        <span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reward</span><span class="p">)</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>        <span class="n">sandbox</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="c1"># Log metrics at this training step for correlation</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="n">session</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>    <span class="k">return</span> <span class="n">rewards</span>
</code></pre></div>
<p>You can also access per-sandbox statistics via the <code>exec_stats</code> property:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">sandbox</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">sandbox</span><span class="p">()</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="n">result</span> <span class="o">=</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">exec</span><span class="p">([</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="nb">print</span><span class="p">(</span><span class="n">sandbox</span><span class="o">.</span><span class="n">exec_stats</span><span class="p">)</span>  <span class="c1"># {&quot;exec_count&quot;: 1, &quot;completed_ok&quot;: 1, &quot;completed_nonzero&quot;: 0, &quot;failures&quot;: 0}</span>
</code></pre></div>
<h3 id="per-sandbox-exec-metrics">Per-sandbox exec metrics<a class="headerlink" href="#per-sandbox-exec-metrics" title="Permanent link">&para;</a></h3>
<p>Sessions with W&amp;B integration also track per-sandbox metrics:</p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>aviato/avg_execs_per_sandbox</code></td>
<td>Average exec() calls per sandbox (useful for "tool calls per rollout")</td>
</tr>
<tr>
<td><code>aviato/min_execs_per_sandbox</code></td>
<td>Minimum exec() calls in any sandbox</td>
</tr>
<tr>
<td><code>aviato/max_execs_per_sandbox</code></td>
<td>Maximum exec() calls in any sandbox</td>
</tr>
</tbody>
</table>
<p>What these tell you about agent behavior:</p>
<ul>
<li><strong>High avg_execs_per_sandbox</strong> may indicate verbose agents that make many tool calls per episode</li>
<li><strong>Large variance (max-min)</strong> may indicate inconsistent rollout behavior across episodes</li>
<li><strong>Trends over training steps</strong> show how agent behavior evolves as the policy improves</li>
</ul>
<p>Example dashboard usage:</p>
<ul>
<li>Plot <code>avg_execs_per_sandbox</code> vs training step to see tool usage trends over training</li>
<li>Alert if <code>max_execs_per_sandbox</code> exceeds a threshold (runaway agent making excessive tool calls)</li>
<li>Compare min/max spread to detect episodes where agents get stuck in loops vs complete quickly</li>
</ul>
<p>By default, <code>log_metrics()</code> resets the counters after logging. Set <code>reset=False</code> to keep accumulating:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">session</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Keep accumulating</span>
</code></pre></div>
<p>Metrics are also logged automatically when the session closes, so you get final summary metrics even without explicit logging.</p>
<h2 id="monitoring-and-debugging">Monitoring and debugging<a class="headerlink" href="#monitoring-and-debugging" title="Permanent link">&para;</a></h2>
<h3 id="counting-active-sandboxes">Counting active sandboxes<a class="headerlink" href="#counting-active-sandboxes" title="Permanent link">&para;</a></h3>
<p>Monitor sandbox usage during training:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aviato</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sandbox</span><span class="p">,</span> <span class="n">SandboxStatus</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">count_active_sandboxes</span><span class="p">(</span><span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="n">sandboxes</span> <span class="o">=</span> <span class="n">Sandbox</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>        <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;wandb-run:</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>        <span class="n">status</span><span class="o">=</span><span class="p">[</span><span class="n">SandboxStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span> <span class="n">SandboxStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">],</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>    <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>        <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sandboxes</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SandboxStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">),</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>        <span class="s2">&quot;pending&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sandboxes</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SandboxStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">),</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>        <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sandboxes</span><span class="p">),</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>    <span class="p">}</span>
</code></pre></div>
<h3 id="logging-execution-details">Logging execution details<a class="headerlink" href="#logging-execution-details" title="Permanent link">&para;</a></h3>
<p>Capture execution details for debugging reward computation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="c1"># Assumes `session` is created at module level</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">logged_reward</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>    <span class="n">code</span> <span class="o">=</span> <span class="n">extract_xml_answer</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span>  <span class="c1"># Extract code from &lt;answer&gt; tags</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>    <span class="n">sandbox</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">sandbox</span><span class="p">()</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>    <span class="n">sandbox</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>        <span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">],</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>        <span class="n">timeout_seconds</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>    <span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>        <span class="s2">&quot;Reward computation&quot;</span><span class="p">,</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>            <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>            <span class="s2">&quot;sandbox_id&quot;</span><span class="p">:</span> <span class="n">sandbox</span><span class="o">.</span><span class="n">sandbox_id</span><span class="p">,</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>            <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>            <span class="s2">&quot;stdout_len&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">),</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>            <span class="s2">&quot;stderr_len&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">),</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>        <span class="p">},</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>    <span class="p">)</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>    <span class="n">sandbox</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>    <span class="k">return</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
</code></pre></div>
<h2 id="multi-step-rollouts-with-art">Multi-step rollouts with ART<a class="headerlink" href="#multi-step-rollouts-with-art" title="Permanent link">&para;</a></h2>
<p>The TRL example above uses sandboxes for <strong>single-shot execution</strong>: one sandbox per completion, execute once, return a reward. This works for training models to generate correct code in one attempt.</p>
<p><strong>Stateful multi-step rollouts</strong> are different: the agent takes multiple actions within a single sandbox, and the sandbox maintains state between actions. The agent can write a file, run it, see the error, edit the file, and try again - all within the same sandbox.</p>
<p>The <code>examples/rl_training/art/</code> directory demonstrates this pattern on the MBPP benchmark. When a solution fails, the agent receives error feedback and can iterate on its approach.</p>
<h3 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/OpenPipe/ART">ART (Agent Reinforcement Trainer)</a> is an open-source RL framework by OpenPipe for training multi-step agents using GRPO. This example integrates Aviato sandboxes with ART:</p>
<ul>
<li>Uses the <code>art</code> package (<code>openpipe-art</code>) for trajectory collection and training</li>
<li>Supports two backends: <code>LocalBackend</code> (requires GPU) or <code>TinkerBackend</code> (no GPU)</li>
<li>Executes code via tool calling in Aviato sandboxes</li>
<li>Computes binary rewards based on MBPP test case results</li>
</ul>
<h3 id="training-approach-grpo-with-distillation">Training approach: GRPO with distillation<a class="headerlink" href="#training-approach-grpo-with-distillation" title="Permanent link">&para;</a></h3>
<p>This example uses <strong>distillation with reinforcement learning</strong>: a stronger model generates demonstrations, and a smaller model learns to replicate the successful ones.</p>
<p><strong>Two models are involved:</strong></p>
<ol>
<li>
<p><strong>Inference model</strong> (<code>--model</code>, default: <code>gpt-5.1-codex-mini</code>): Generates trajectories during rollouts. This model makes tool calls, sees sandbox results, iterates on errors, and submits solutions. It does not get trained.</p>
</li>
<li>
<p><strong>Base model</strong> (<code>--base-model</code>, default: <code>Qwen/Qwen3-8B</code>): The model being trained. It receives the trajectories generated by the inference model and learns from them via GRPO (Group Relative Policy Optimization).</p>
</li>
</ol>
<p><strong>How it works:</strong></p>
<ol>
<li>The inference model generates multiple trajectories per problem, each with tool calls executed in Aviato sandboxes</li>
<li>Each trajectory receives a binary reward: 1.0 if tests pass, 0.0 otherwise</li>
<li>Trajectories for the same problem form a group - GRPO compares trajectories within each group</li>
<li>The base model (Qwen3-8B) is trained to prefer higher-reward trajectories over lower-reward ones</li>
</ol>
<p>After training, you deploy Qwen3-8B with the same tool definitions. It will have learned to make similar tool calls by imitating the successful trajectories from the inference model.</p>
<h3 id="prerequisites_1">Prerequisites<a class="headerlink" href="#prerequisites_1" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Requirements</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dry run</td>
<td>CPU only</td>
</tr>
<tr>
<td>TinkerBackend</td>
<td>CPU only (training via API)</td>
</tr>
<tr>
<td>LocalBackend</td>
<td>GPU required</td>
</tr>
</tbody>
</table>
<p>Environment variables:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">AVIATO_API_KEY</span><span class="o">=</span><span class="s2">&quot;your-aviato-key&quot;</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span><span class="s2">&quot;your-openai-key&quot;</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">ART_TINKER_API_KEY</span><span class="o">=</span><span class="s2">&quot;your-tinker-key&quot;</span><span class="w">  </span><span class="c1"># required for --backend=tinker</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="nb">export</span><span class="w"> </span><span class="nv">WANDB_API_KEY</span><span class="o">=</span><span class="s2">&quot;your-wandb-key&quot;</span><span class="w">        </span><span class="c1"># optional, for logging</span>
</code></pre></div>
<h3 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>examples/rl_training/art/requirements.txt
</code></pre></div>
<p>This installs:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>openpipe-art==0.5.7       # ART framework
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>openai==2.15.0            # LLM inference
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>datasets==4.5.0           # MBPP loading
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>wandb==0.24.0             # Optional logging
</code></pre></div>
<p>For LocalBackend with GPU support, also install:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;openpipe-art[backend]==0.5.7&quot;</span>
</code></pre></div>
<h3 id="running-the-example">Running the example<a class="headerlink" href="#running-the-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># Dry run - validate setup without training</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>uv<span class="w"> </span>run<span class="w"> </span>examples/rl_training/art/train.py<span class="w"> </span>--dry-run
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="c1"># Train with TinkerBackend (no local GPU required)</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>uv<span class="w"> </span>run<span class="w"> </span>examples/rl_training/art/train.py<span class="w"> </span>--backend<span class="w"> </span>tinker<span class="w"> </span>--num-problems<span class="w"> </span><span class="m">10</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="c1"># Train with LocalBackend (requires GPU)</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>uv<span class="w"> </span>run<span class="w"> </span>examples/rl_training/art/train.py<span class="w"> </span>--backend<span class="w"> </span><span class="nb">local</span><span class="w"> </span>--num-problems<span class="w"> </span><span class="m">10</span>
</code></pre></div>
<p>Expected output:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>ART Training with Aviato Sandboxes
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>========================================
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>Backend: tinker
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>Model: gpt-5.1-codex-mini
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>Base model: Qwen/Qwen3-8B
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>Problems: 10
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>Steps: 5
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>Trajectories per problem: 2
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>Project: aviato-mbpp
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>Run name: train-001
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>Loading MBPP problems...
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>Loaded 10 problems
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>Creating tinker backend...
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>Creating trainable model...
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>Registering model with backend...
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>Starting training...
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>=== Step 1 ===
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>Collecting trajectories for 10 problems...
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a>step 1: 100%|| 10/10 [00:45&lt;00:00]
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>Collected 20 trajectories, avg reward: 0.35
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a>Training...
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a>Training complete: step=1, metrics={&#39;loss&#39;: 0.42}
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a>...
</code></pre></div>
<h3 id="configuration-options">Configuration options<a class="headerlink" href="#configuration-options" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--backend</code></td>
<td><code>local</code></td>
<td>Training backend: <code>local</code> (GPU) or <code>tinker</code> (no GPU)</td>
</tr>
<tr>
<td><code>--model</code></td>
<td><code>gpt-5.1-codex-mini</code></td>
<td>Model for inference</td>
</tr>
<tr>
<td><code>--base-model</code></td>
<td><code>Qwen/Qwen3-8B</code></td>
<td>Base model for training</td>
</tr>
<tr>
<td><code>--num-problems</code></td>
<td><code>10</code></td>
<td>Number of MBPP problems</td>
</tr>
<tr>
<td><code>--num-steps</code></td>
<td><code>5</code></td>
<td>Training steps</td>
</tr>
<tr>
<td><code>--trajectories-per-problem</code></td>
<td><code>2</code></td>
<td>Trajectories collected per problem per step</td>
</tr>
<tr>
<td><code>--base-url</code></td>
<td><code>None</code></td>
<td>OpenAI-compatible API base URL</td>
</tr>
<tr>
<td><code>--project</code></td>
<td><code>aviato-mbpp</code></td>
<td>W&amp;B project name</td>
</tr>
<tr>
<td><code>--run-name</code></td>
<td><code>train-001</code></td>
<td>Training run name</td>
</tr>
<tr>
<td><code>--learning-rate</code></td>
<td><code>1e-5</code></td>
<td>Learning rate</td>
</tr>
<tr>
<td><code>--dry-run</code></td>
<td><code>false</code></td>
<td>Validate setup without training</td>
</tr>
</tbody>
</table>
<h3 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>art/
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a> train.py         # Training loop, CLI, and ART backend setup
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a> rollout.py       # Multi-step sandbox execution, builds Trajectory
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a> tools.py         # Tool schemas for execute_code and submit_solution
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a> __init__.py
</code></pre></div>
<p><strong>Key ART imports:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">art</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">art.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalBackend</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">art.tinker</span><span class="w"> </span><span class="kn">import</span> <span class="n">TinkerBackend</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="c1"># Create trainable model</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="n">model</span> <span class="o">=</span> <span class="n">art</span><span class="o">.</span><span class="n">TrainableModel</span><span class="p">(</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;train-001&quot;</span><span class="p">,</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>    <span class="n">project</span><span class="o">=</span><span class="s2">&quot;aviato-mbpp&quot;</span><span class="p">,</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>    <span class="n">base_model</span><span class="o">=</span><span class="s2">&quot;Qwen/Qwen3-8B&quot;</span><span class="p">,</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="p">)</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="c1"># Collect trajectories</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="n">groups</span> <span class="o">=</span> <span class="k">await</span> <span class="n">art</span><span class="o">.</span><span class="n">gather_trajectory_groups</span><span class="p">(</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>    <span class="p">(</span><span class="n">collect_trajectories</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span> <span class="k">for</span> <span class="n">problem</span> <span class="ow">in</span> <span class="n">problems</span><span class="p">),</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>    <span class="n">pbar_desc</span><span class="o">=</span><span class="s2">&quot;collecting&quot;</span><span class="p">,</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="p">)</span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="c1"># Train</span>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backend</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</code></pre></div>
<p><strong>Rollout returns <code>art.Trajectory</code>:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">openai.types.chat</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatCompletionToolParam</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="n">trajectory</span> <span class="o">=</span> <span class="n">art</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>    <span class="n">messages_and_choices</span><span class="o">=</span><span class="n">messages_and_choices</span><span class="p">,</span>  <span class="c1"># Conversation history</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>    <span class="n">tools</span><span class="o">=</span><span class="n">ROLLOUT_TOOLS</span><span class="p">,</span>                        <span class="c1"># Tool definitions</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>    <span class="n">reward</span><span class="o">=</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">passed</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>              <span class="c1"># Binary reward</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">problem</span><span class="o">.</span><span class="n">task_id</span><span class="p">},</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="p">)</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="k">return</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</code></pre></div>
<p><strong>Tool-calling pattern:</strong></p>
<p>The rollout uses OpenAI-compatible tool calling with two tools:
- <code>execute_code</code>: Test code in sandbox, returns stdout/stderr
- <code>submit_solution</code>: Final submission, runs all test cases</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">ROLLOUT_TOOLS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ChatCompletionToolParam</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>    <span class="p">{</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;execute_code&quot;</span><span class="p">,</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Execute Python code in an isolated sandbox...&quot;</span><span class="p">,</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}},</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>            <span class="p">},</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>        <span class="p">},</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>    <span class="p">},</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>    <span class="c1"># submit_solution tool...</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="p">]</span>
</code></pre></div>
<p>Sandboxes are tagged for tracking:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">sandbox_defaults</span> <span class="o">=</span> <span class="n">SandboxDefaults</span><span class="p">(</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>    <span class="n">container_image</span><span class="o">=</span><span class="s2">&quot;python:3.11&quot;</span><span class="p">,</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>    <span class="n">tags</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;art-training&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">run_name</span><span class="p">),</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="p">)</span>
</code></pre></div>
<h3 id="data-flow">Data flow<a class="headerlink" href="#data-flow" title="Permanent link">&para;</a></h3>
<p>The training pipeline has several components:</p>
<ol>
<li>
<p><strong>Local machine</strong>: The training script (<code>train.py</code>) runs on your machine or training server. It loads problems from the MBPP dataset and orchestrates the training loop.</p>
</li>
<li>
<p><strong>OpenAI API (inference)</strong>: During trajectory collection, the rollout code calls the OpenAI API (or compatible endpoint) to generate model responses. The model receives tool definitions and returns tool calls that the rollout executes.</p>
</li>
<li>
<p><strong>Aviato sandboxes (code execution)</strong>: Each rollout uses a single Aviato sandbox that persists across all tool calls. When the model calls <code>execute_code</code> or <code>submit_solution</code>, the code runs in that sandbox. This means file changes and state accumulate as the agent iterates - it can write a file, run it, see an error, and fix it. The sandbox provides isolation so untrusted model-generated code cannot affect the host. Results (stdout, stderr, exit code) flow back to the rollout.</p>
</li>
<li>
<p><strong>Trajectory collection</strong>: The rollout accumulates the conversation history (messages and tool results) along with the final reward into an <code>art.Trajectory</code> object. Multiple trajectories for the same problem form an <code>art.TrajectoryGroup</code>.</p>
</li>
<li>
<p><strong>Training backend</strong>: The collected trajectory groups are sent to the training backend. With <code>LocalBackend</code>, training happens on your local GPU. With <code>TinkerBackend</code>, trajectories are uploaded to Thinking Machines's Tinker service which handles training remotely - no local GPU required.</p>
</li>
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.top", "search.suggest", "content.code.copy"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>